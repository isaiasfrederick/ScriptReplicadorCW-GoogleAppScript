CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`%` SQL SECURITY DEFINER VIEW `saque` AS select distinct `te`.`tr_id` AS `saque_id`,`te`.`serial_number` AS `saque_terminal`,`te`.`split_wallet_id2` AS `saque_carteira`,`te`.`cartao_bandeira` AS `saque_bandeira`,concat(`te`.`cartao_primeiros_digitos`,'_',`te`.`cartao_ultimos_digitos`,'_',`te`.`cartao_data_expiracao`) AS `saque_cartao`,cast((cast(`te`.`tr_montante` as decimal(10,4)) / 100.00) as decimal(10,2)) AS `saque_montante`,cast((cast(`te`.`saque_valor` as decimal(10,4)) / 100.00) as decimal(10,2)) AS `saque_valor`,cast((cast(`te`.`saque_taxa` as decimal(10,4)) / 100.00) as decimal(10,2)) AS `saque_taxa`,cast((cast(`te`.`split_wallet_id1_montante` as decimal(10,4)) / 100.0) as decimal(10,2)) AS `saque_margem_split`,cast((((cast(`te`.`tr_montante` as decimal(10,4)) * `te`.`percentagem_mdr`) / 10000) - ((cast(`te`.`tr_montante` as decimal(10,4)) * `hb`.`percent_mdr`) / 10000)) as decimal(10,2)) AS `saque_margem_mdr`,cast((ceiling(((((cast(`te`.`split_wallet_id2_montante` as decimal(10,4)) / 100.0) - (((`te`.`percentagem_mdr` / 100.0) * cast(`te`.`tr_montante` as decimal(10,4))) / 100.0)) - (cast(`te`.`saque_valor` as decimal(10,4)) / 100.0)) * 100)) / 100.0) as decimal(6,2)) AS `saque_comissao`,date_format(str_to_date(`te`.`tr_data_fim`,'%Y-%m-%dT%H:%i:%s'),'%Y-%m-%d %H:%i:%s') AS `saque_datahora`,`te`.`merchant_name` AS `saque_comercio`,`cli`.`cliente_apelido` AS `cliente_apelido`,`cli`.`cliente_cidade` AS `cliente_cidade`,`cli`.`cliente_estado` AS `cliente_estado`,`cli`.`cliente_pais` AS `cliente_pais` from ((`transacoes_estruturadas` `te` join `historico_mdr_bandeira` `hb` on(((`te`.`cartao_bandeira` = `hb`.`bandeira`) and (((`te`.`tr_data_inicio` >= `hb`.`data_inicio`) and isnull(`hb`.`data_final`)) or ((`te`.`tr_data_inicio` >= `hb`.`data_inicio`) and (`hb`.`data_final` >= `te`.`tr_data_fim`)))))) join `cliente` `cli` on((`cli`.`cliente_carteira` = `te`.`merchant_wallet`))) where ((`te`.`tr_status` = 'approved') and (`te`.`tr_tipo` = 'debit') and (`te`.`split_regra_texto_json` <> '') and (`te`.`split_regra_texto_json` is not null) and (`te`.`split_wallet_id2` <> '') and (`te`.`split_wallet_id1` <> ''));

